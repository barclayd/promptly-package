# @promptlycms/prompts

TypeScript SDK for the [Promptly CMS](https://promptlycms.com) API. Fetch prompts at runtime, get typed template variables via codegen, and integrate with the [Vercel AI SDK](https://sdk.vercel.ai).

## Install

```bash
npm install @promptlycms/prompts
# or
bun add @promptlycms/prompts
```

Peer dependencies: `zod@^4`, `ai@^4 || ^5 || ^6`, `typescript@^5`

## Quick start

### 1. Set your API key

```bash
# .env
PROMPTLY_API_KEY=pk_live_...
```

### 2. Generate types (optional but recommended)

```bash
npx promptly generate
```

This fetches all your prompts from the API and generates a `promptly-env.d.ts` file in your project root. This gives you typed autocomplete on `userMessage()` variables for every prompt ID.

```bash
# Custom output path
npx promptly generate --output ./types/promptly-env.d.ts

# Pass API key directly
npx promptly generate --api-key pk_live_...
```

### 3. Create a client

```typescript
import { createPromptClient } from '@promptlycms/prompts';

const promptly = createPromptClient({
  apiKey: process.env.PROMPTLY_API_KEY,
});
```

## Fetching prompts

### Single prompt

```typescript
const result = await promptly.get('JPxlUpstuhXB5OwOtKPpj');

// Access prompt metadata
result.promptId;      // 'JPxlUpstuhXB5OwOtKPpj'
result.promptName;    // 'Review Prompt'
result.systemMessage; // 'You are a helpful assistant.'
result.temperature;   // 0.7

// Interpolate template variables (typed if you ran codegen)
const message = result.userMessage({
  pickupLocation: 'London',
  items: 'sofa',
});

// Get the raw template string
const template = String(result.userMessage);
// => 'Help with ${pickupLocation} moving ${items}.'
```

Fetch a specific version:

```typescript
const result = await promptly.get('JPxlUpstuhXB5OwOtKPpj', {
  version: '2.0.0',
});
```

### Batch fetch

Fetch multiple prompts in parallel with typed results per position:

```typescript
import type { PromptRequest } from '@promptlycms/prompts';

const [reviewPrompt, welcomePrompt] = await promptly.getPrompts([
  { promptId: 'JPxlUpstuhXB5OwOtKPpj' },
  { promptId: 'abc123', version: '2.0.0' },
]);

// Each result is typed to its own prompt's variables
reviewPrompt.userMessage({ pickupLocation: 'London', items: 'sofa' });
welcomePrompt.userMessage({ email: 'a@b.com', subject: 'Hi' });
```

## AI SDK integration

`aiParams()` returns an object you can spread directly into Vercel AI SDK functions:

```typescript
import { generateText } from 'ai';
import { anthropic } from '@ai-sdk/anthropic';

const params = await promptly.aiParams('my-prompt', {
  variables: { name: 'Alice', task: 'coding' },
});

const { text } = await generateText({
  model: anthropic('claude-sonnet-4-5-20250929'),
  ...params,
});
```

If the prompt has a structured output schema defined in the CMS, `params.output` is automatically populated with a Zod schema wrapped in `Output.object()`.

## Type generation

Running `npx promptly generate` creates a `promptly-env.d.ts` file that uses [declaration merging](https://www.typescriptlang.org/docs/handbook/declaration-merging.html) to narrow types:

```typescript
// Auto-generated by @promptlycms/prompts — do not edit
import '@promptlycms/prompts';

declare module '@promptlycms/prompts' {
  interface PromptVariableMap {
    'JPxlUpstuhXB5OwOtKPpj': {
      pickupLocation: string;
      items: string;
    };
    'abc123': {
      email: string;
      subject: string;
    };
  }
}
```

With this file present, `get()` and `getPrompts()` return typed `userMessage` functions with autocomplete. Unknown prompt IDs fall back to `Record<string, string>`.

Add the generated file to version control so types are available without running codegen in CI:

```bash
# .gitignore — do NOT ignore promptly-env.d.ts
```

Re-run `npx promptly generate` whenever you add, remove, or rename template variables in the CMS.

## Error handling

All API errors throw `PromptlyError`:

```typescript
import { PromptlyError } from '@promptlycms/prompts';

try {
  await promptly.get('nonexistent');
} catch (err) {
  if (err instanceof PromptlyError) {
    err.code;       // 'NOT_FOUND' | 'INVALID_KEY' | 'USAGE_LIMIT_EXCEEDED' | ...
    err.status;     // HTTP status code
    err.message;    // Human-readable error message
    err.usage;      // Usage data (on 429s)
    err.upgradeUrl; // Upgrade link (on 429s)
  }
}
```

## API reference

### `createPromptClient(config)`

| Option    | Type     | Required | Description                                        |
|-----------|----------|----------|----------------------------------------------------|
| `apiKey`  | `string` | Yes      | Your Promptly CMS API key                          |
| `baseUrl` | `string` | No       | API base URL (default: `https://api.promptlycms.com`) |

Returns a `PromptClient` with `get()`, `getPrompts()`, and `aiParams()` methods.

### `client.get(promptId, options?)`

Fetch a single prompt. Returns `PromptResult` with typed `userMessage` when codegen types are present.

### `client.getPrompts(entries)`

Fetch multiple prompts in parallel. Accepts `PromptRequest[]` and returns a typed tuple matching the input order.

### `client.aiParams(promptId, options?)`

Fetch a prompt and return params ready to spread into AI SDK functions (`system`, `prompt`, `temperature`, and optionally `output`).

### CLI: `npx promptly generate`

| Flag        | Alias | Description                                          |
|-------------|-------|------------------------------------------------------|
| `--api-key` |       | API key (defaults to `PROMPTLY_API_KEY` env var)     |
| `--output`  | `-o`  | Output path (default: `./promptly-env.d.ts`)         |
